#!/usr/bin/env python3

# ---------------------------
# tumrod/cs373-netflix/Netflix.py
# Copyright (C) 2015
# Tipparat Umrod
# ---------------------------

from numpy     import mean, sqrt, square, subtract
from urllib.request import urlopen
import math
import json
movies_id = 0
total_viewer = 0

avg_avg_movies = 3.2281371945
avg_avg_customer = 3.67413045111
avg_movies_rate = {}
avg_customer_rate = {}
expected = {}

#avg_movies_rate = {"2043":3.7776648456358783, "10851":3.8544080604534003, "4610": 3.4409799554565703, "7168": 3.885803851321093, "461": 3.46875, "7057": 4.702611063648014, "7167": 2.3421052631578947}
#avg_customer_rate = {'1417435': 3.508816120906801, '462685': 3.792405063291139, '2312054': 4.457142857142857,"1977373": 4.01555023923445, "272772": 3.99388379204893, "2436518": 4.507692307692308, "1672477": 4.2465753424657535, "2227664": 3.5153970826580228, "1755808": 3.6, "1059385": 3.490566037735849, "109112": 3.6855100714749836, "2280882": 3.9532467532467535, "2617555": 4.649681528662421, "1449813": 4.019230769230769, "1364038": 3.5789473684210527, "2045800": 3.6956521739130435, "236989": 3.8627450980392157, "1401198": 4.089820359281437, "2328117": 4.488505747126437, "202455": 4.470588235294118, "419313": 3.6893617021276595, "870496": 3.745664739884393, "2586172": 3.962962962962963, "345925": 3.888704318936877, "1253590": 3.8166089965397925, "1745120": 4.246913580246914, "14060": 4.448387096774193, "296989": 4.1341681574239715, "50400": 4.140396659707725, "2198961": 3.076923076923077, "776857": 3.4782608695652173, "1240568": 3.377049180327869, "1792794": 3.8125, "1223867": 3.900900900900901, "1372581": 3.8275862068965516, "417363": 3.479338842975207, "2060373": 3.9100719424460433, "1892264": 3.7971500419111486, "2195117": 4.377551020408164, "990064": 4.25, "348114": 3.86, "826793": 3.4878048780487805, "1382465": 3.7567567567567566, "1939357": 3.670918367346939, "1520875": 3.7966101694915255, "1048550": 3.2147001934235977, "1076295": 3.628352490421456, "1778576": 4.312020460358056, "1400207": 3.6151515151515152, "1135276": 3.7557251908396947, "1845276": 3.594059405940594, "2240805": 4.0, "1951693": 4.029411764705882, "150547": 3.8641975308641974, "1258134": 3.3734939759036147, "1358210": 4.328042328042328, "1731764": 3.638888888888889, "1202021": 3.2953846153846156, "64422": 3.5, "875402": 3.189873417721519, "1282645": 3.582089552238806, "2648436": 3.6639344262295084, "2218547": 3.91726618705036, "2569597": 4.2631578947368425, "662879": 4.217465753424658, "1443683": 4.24468085106383, "323893": 4.766666666666667, "1412869": 4.214285714285714, "1373038": 3.4265734265734267, "54781": 3.5189620758483033, "1533444": 3.695, "881929": 3.4587628865979383, "1668353": 3.5128205128205128, "1993729": 3.8297872340425534, "1620134": 3.4878048780487805, "2025409": 4.235294117647059, "497615": 3.504424778761062, "1596762": 3.5780730897009967, "1415648": 4.32520325203252, "2214251": 3.0435897435897434, "23819": 4.1395348837209305, "2151618": 3.7717622080679405, "1587696": 3.6600985221674875, "2338216": 4.386363636363637, "848750": 3.8404907975460123, "163043": 4.62, "2311816": 3.931166347992352, "109734": 4.65625, "2601453": 3.7741116751269037, "1463256": 4.230769230769231, "837786": 3.9657534246575343, "240308": 3.853801169590643, "2251346": 3.625615763546798, "593278": 4.072727272727272, "629664": 3.375, "1525309": 3.318681318681319, "1978844": 3.1945454545454544, "737244": 3.781609195402299, "2145185": 3.7010309278350517, "2094602": 3.055393586005831, "2075019": 4.186046511627907, "1458847": 3.1319148936170214, "993870": 3.129277566539924, "179980": 3.7177033492822966, "2417642": 3.1615384615384614, "2056724": 3.2906976744186047, "1131433": 4.205128205128205, "738504": 3.3098039215686272, "155818": 4.053003533568905, "1108378": 3.339425587467363, "1987339": 3.1372549019607843, "1759328": 4.368421052631579, "1940764": 3.147804054054054, "695328": 3.98125, "2126814": 4.271428571428571, "798841": 3.709090909090909, "1900217": 2.0588235294117645, "2507699": 3.9134615384615383, "437074": 4.015873015873016, "1137834": 3.74025974025974, "1372847": 4.04140127388535, "915201": 3.760869565217391, "636052": 3.96875, "2207453": 3.9127906976744184, "386143": 3.8575757575757574, "2288234": 3.2335329341317367, "1633927": 3.4523809523809526, "83054": 3.782258064516129, "2522930": 3.6129032258064515}
#expected = {"2043":{'1417435': 3, '462685': 4, '2312054': 1}, "10851":{'1417435': 3, '462685': 5, '2312054': 4},"7057": {"437074": 5, "776857": 4, "2280882": 4, "272772": 5, "1987339": 5, "1759328": 4, "1135276": 4, "1463256": 5, "2060373": 5, "636052": 5, "497615": 5, "1412869": 5, "386143": 3, "2195117": 5, "14060": 5, "202455": 4, "1900217": 5, "1443683": 5, "179980": 1, "2569597": 5, "2251346": 3, "1400207": 5, "1373038": 5, "109734": 4, "1845276": 3, "993870": 5, "1372581": 5, "593278": 3, "2436518": 4, "83054": 4, "2617555": 5, "1620134": 5, "1382465": 5, "1792794": 5, "50400": 5, "629664": 4, "2522930": 2, "2207453": 5, "1533444": 5, "1940764": 1, "296989": 5, "1633927": 5, "23819": 5, "1048550": 4, "1223867": 5, "1458847": 5, "2601453": 5, "1401198": 5, "1731764": 5, "109112": 2, "837786": 5, "870496": 5, "1755808": 5, "1059385": 3, "2056724": 1, "1993729": 5, "236989": 4, "990064": 5, "2288234": 3, "2145185": 5, "2240805": 5, "2025409": 5, "1745120": 5, "348114": 5, "1668353": 5, "1358210": 5, "2417642": 5, "155818": 5, "240308": 4, "1137834": 5, "1525309": 5, "2311816": 5, "2094602": 3, "738504": 5, "1587696": 5, "1978844": 4, "1364038": 4, "2586172": 5, "1951693": 5, "2328117": 5, "2214251": 5, "150547": 4, "2151618": 4, "662879": 5, "1202021": 4, "1131433": 2, "1372847": 5, "1449813": 5, "881929": 5, "695328": 5, "848750": 5, "1282645": 5, "1415648": 5, "2045800": 4, "1939357": 5, "2126814": 5, "1596762": 4, "826793": 5, "2227664": 4, "1892264": 4, "2338216": 5, "419313": 4, "875402": 5, "1258134": 5, "1778576": 5, "163043": 5, "2507699": 5, "1672477": 5, "323893": 5, "2198961": 2, "798841": 4, "915201": 3, "2218547": 4, "64422": 4, "2648436": 4, "417363": 5, "1240568": 5, "737244": 5, "1076295": 5, "1108378": 5, "2075019": 5, "345925": 5, "1520875": 5, "1253590": 5, "54781": 5, "1977373": 5}, "7168": {"437074": 5, "776857": 4, "2280882": 4, "272772": 5, "1987339": 5, "1759328": 4, "1135276": 4, "1463256": 5, "2060373": 5, "636052": 5, "497615": 5, "1412869": 5, "386143": 3, "2195117": 5, "14060": 5, "202455": 4, "1900217": 5, "1443683": 5, "179980": 1, "2569597": 5, "2251346": 3, "1400207": 5, "1373038": 5, "109734": 4, "1845276": 3, "993870": 5, "1372581": 5, "593278": 3, "2436518": 4, "83054": 4, "2617555": 5, "1620134": 5, "1382465": 5, "1792794": 5, "50400": 5, "629664": 4, "2522930": 2, "2207453": 5, "1533444": 5, "1940764": 1, "296989": 5, "1633927": 5, "23819": 5, "1048550": 4, "1223867": 5, "1458847": 5, "2601453": 5, "1401198": 5, "1731764": 5, "109112": 2, "837786": 5, "870496": 5, "1755808": 5, "1059385": 3, "2056724": 1, "1993729": 5, "236989": 4, "990064": 5, "2288234": 3, "2145185": 5, "2240805": 5, "2025409": 5, "1745120": 5, "348114": 5, "1668353": 5, "1358210": 5, "2417642": 5, "155818": 5, "240308": 4, "1137834": 5, "1525309": 5, "2311816": 5, "2094602": 3, "738504": 5, "1587696": 5, "1978844": 4, "1364038": 4, "2586172": 5, "1951693": 5, "2328117": 5, "2214251": 5, "150547": 4, "2151618": 4, "662879": 5, "1202021": 4, "1131433": 2, "1372847": 5, "1449813": 5, "881929": 5, "695328": 5, "848750": 5, "1282645": 5, "1415648": 5, "2045800": 4, "1939357": 5, "2126814": 5, "1596762": 4, "826793": 5, "2227664": 4, "1892264": 4, "2338216": 5, "419313": 4, "875402": 5, "1258134": 5, "1778576": 5, "163043": 5, "2507699": 5, "1672477": 5, "323893": 5, "2198961": 2, "798841": 4, "915201": 3, "2218547": 4, "64422": 4, "2648436": 4, "417363": 5, "1240568": 5, "737244": 5, "1076295": 5, "1108378": 5, "2075019": 5, "345925": 5, "1520875": 5, "1253590": 5, "54781": 5, "1977373": 5}, "7167": {"437074": 5, "776857": 4, "2280882": 4, "272772": 5, "1987339": 5, "1759328": 4, "1135276": 4, "1463256": 5, "2060373": 5, "636052": 5, "497615": 5, "1412869": 5, "386143": 3, "2195117": 5, "14060": 5, "202455": 4, "1900217": 5, "1443683": 5, "179980": 1, "2569597": 5, "2251346": 3, "1400207": 5, "1373038": 5, "109734": 4, "1845276": 3, "993870": 5, "1372581": 5, "593278": 3, "2436518": 4, "83054": 4, "2617555": 5, "1620134": 5, "1382465": 5, "1792794": 5, "50400": 5, "629664": 4, "2522930": 2, "2207453": 5, "1533444": 5, "1940764": 1, "296989": 5, "1633927": 5, "23819": 5, "1048550": 4, "1223867": 5, "1458847": 5, "2601453": 5, "1401198": 5, "1731764": 5, "109112": 2, "837786": 5, "870496": 5, "1755808": 5, "1059385": 3, "2056724": 1, "1993729": 5, "236989": 4, "990064": 5, "2288234": 3, "2145185": 5, "2240805": 5, "2025409": 5, "1745120": 5, "348114": 5, "1668353": 5, "1358210": 5, "2417642": 5, "155818": 5, "240308": 4, "1137834": 5, "1525309": 5, "2311816": 5, "2094602": 3, "738504": 5, "1587696": 5, "1978844": 4, "1364038": 4, "2586172": 5, "1951693": 5, "2328117": 5, "2214251": 5, "150547": 4, "2151618": 4, "662879": 5, "1202021": 4, "1131433": 2, "1372847": 5, "1449813": 5, "881929": 5, "695328": 5, "848750": 5, "1282645": 5, "1415648": 5, "2045800": 4, "1939357": 5, "2126814": 5, "1596762": 4, "826793": 5, "2227664": 4, "1892264": 4, "2338216": 5, "419313": 4, "875402": 5, "1258134": 5, "1778576": 5, "163043": 5, "2507699": 5, "1672477": 5, "323893": 5, "2198961": 2, "798841": 4, "915201": 3, "2218547": 4, "64422": 4, "2648436": 4, "417363": 5, "1240568": 5, "737244": 5, "1076295": 5, "1108378": 5, "2075019": 5, "345925": 5, "1520875": 5, "1253590": 5, "54781": 5, "1977373": 5}, "461": {"437074": 5, "776857": 4, "2280882": 4, "272772": 5, "1987339": 5, "1759328": 4, "1135276": 4, "1463256": 5, "2060373": 5, "636052": 5, "497615": 5, "1412869": 5, "386143": 3, "2195117": 5, "14060": 5, "202455": 4, "1900217": 5, "1443683": 5, "179980": 1, "2569597": 5, "2251346": 3, "1400207": 5, "1373038": 5, "109734": 4, "1845276": 3, "993870": 5, "1372581": 5, "593278": 3, "2436518": 4, "83054": 4, "2617555": 5, "1620134": 5, "1382465": 5, "1792794": 5, "50400": 5, "629664": 4, "2522930": 2, "2207453": 5, "1533444": 5, "1940764": 1, "296989": 5, "1633927": 5, "23819": 5, "1048550": 4, "1223867": 5, "1458847": 5, "2601453": 5, "1401198": 5, "1731764": 5, "109112": 2, "837786": 5, "870496": 5, "1755808": 5, "1059385": 3, "2056724": 1, "1993729": 5, "236989": 4, "990064": 5, "2288234": 3, "2145185": 5, "2240805": 5, "2025409": 5, "1745120": 5, "348114": 5, "1668353": 5, "1358210": 5, "2417642": 5, "155818": 5, "240308": 4, "1137834": 5, "1525309": 5, "2311816": 5, "2094602": 3, "738504": 5, "1587696": 5, "1978844": 4, "1364038": 4, "2586172": 5, "1951693": 5, "2328117": 5, "2214251": 5, "150547": 4, "2151618": 4, "662879": 5, "1202021": 4, "1131433": 2, "1372847": 5, "1449813": 5, "881929": 5, "695328": 5, "848750": 5, "1282645": 5, "1415648": 5, "2045800": 4, "1939357": 5, "2126814": 5, "1596762": 4, "826793": 5, "2227664": 4, "1892264": 4, "2338216": 5, "419313": 4, "875402": 5, "1258134": 5, "1778576": 5, "163043": 5, "2507699": 5, "1672477": 5, "323893": 5, "2198961": 2, "798841": 4, "915201": 3, "2218547": 4, "64422": 4, "2648436": 4, "417363": 5, "1240568": 5, "737244": 5, "1076295": 5, "1108378": 5, "2075019": 5, "345925": 5, "1520875": 5, "1253590": 5, "54781": 5, "1977373": 5}, "4610": {"437074": 5, "776857": 4, "2280882": 4, "272772": 5, "1987339": 5, "1759328": 4, "1135276": 4, "1463256": 5, "2060373": 5, "636052": 5, "497615": 5, "1412869": 5, "386143": 3, "2195117": 5, "14060": 5, "202455": 4, "1900217": 5, "1443683": 5, "179980": 1, "2569597": 5, "2251346": 3, "1400207": 5, "1373038": 5, "109734": 4, "1845276": 3, "993870": 5, "1372581": 5, "593278": 3, "2436518": 4, "83054": 4, "2617555": 5, "1620134": 5, "1382465": 5, "1792794": 5, "50400": 5, "629664": 4, "2522930": 2, "2207453": 5, "1533444": 5, "1940764": 1, "296989": 5, "1633927": 5, "23819": 5, "1048550": 4, "1223867": 5, "1458847": 5, "2601453": 5, "1401198": 5, "1731764": 5, "109112": 2, "837786": 5, "870496": 5, "1755808": 5, "1059385": 3, "2056724": 1, "1993729": 5, "236989": 4, "990064": 5, "2288234": 3, "2145185": 5, "2240805": 5, "2025409": 5, "1745120": 5, "348114": 5, "1668353": 5, "1358210": 5, "2417642": 5, "155818": 5, "240308": 4, "1137834": 5, "1525309": 5, "2311816": 5, "2094602": 3, "738504": 5, "1587696": 5, "1978844": 4, "1364038": 4, "2586172": 5, "1951693": 5, "2328117": 5, "2214251": 5, "150547": 4, "2151618": 4, "662879": 5, "1202021": 4, "1131433": 2, "1372847": 5, "1449813": 5, "881929": 5, "695328": 5, "848750": 5, "1282645": 5, "1415648": 5, "2045800": 4, "1939357": 5, "2126814": 5, "1596762": 4, "826793": 5, "2227664": 4, "1892264": 4, "2338216": 5, "419313": 4, "875402": 5, "1258134": 5, "1778576": 5, "163043": 5, "2507699": 5, "1672477": 5, "323893": 5, "2198961": 2, "798841": 4, "915201": 3, "2218547": 4, "64422": 4, "2648436": 4, "417363": 5, "1240568": 5, "737244": 5, "1076295": 5, "1108378": 5, "2075019": 5, "345925": 5, "1520875": 5, "1253590": 5, "54781": 5, "1977373": 5}}



def json_cache(file_url):

    url = urlopen(file_url)
    cache = json.loads(url.read().decode(url.info().get_param('charset') or 'utf-8'))

    return cache
    #with open('http://www.cs.utexas.edu/users/ebanner/netflix-tests/ezo55-Average_Viewer_Rating_Cache.json') as viewer_file:
    #    avg_customer_rate = json.load(viewer_file)
    #with open('http://www.cs.utexas.edu/users/ebanner/netflix-tests/BRG564-Average_Movie_Rating_Cache.json') as movies_file:
    #    avg_movies_rate = json.load(movies_file)
    #with open('http://www.cs.utexas.edu/users/ebanner/netflix-tests/pam2599-probe_solutions.json') as expected_file:
    #    expected = json.load(expected_file)




# ------------
# netflix_read
# ------------

def netflix_read (s) :
    """
    read an int
    s a string

    set movies_id to global if read movies_id
    get customer_id
    return a list of movies_id, customer_id pair
    """
    global movies_id

    customer_id = 0

    if ":" in s :
        s = s[:-2]
        movies_id = int(s)
        assert movies_id != 0
    else :
        assert movies_id != 0
        customer_id = int(s)

    return [movies_id, customer_id]


# ------------
# netflix_eval
# ------------

def netflix_eval (i, j):
    """
    i movies_id
    j customer_id
    return rating
    
    avg_movies = avg_movies_rate[str(i)]
    rating = 0
    if(j != 0) :
        avg_personal = avg_customer_rate[str(j)]
        expected_rate = expected[str(i)][str(j)]
        diff = avg_movies - avg_personal

        if (diff > 0.1):
            rating = int(avg_movies)

        print(diff, expected_rate, rating)
        #print(avg_movies, avg_personal, expected[str(i)][str(j)])
    """

    avg_movies = avg_movies_rate[str(i)]
    rating = avg_movies
    diff = 0
    movies_quality = ""
    viewer_quality = ""

    movies_factor = 0
    viewer_factor = 0

    
    if(j != 0) :

        avg_personal = avg_customer_rate[str(j)]
        expected_rate = expected[str(i)][str(j)]
        #diff = round(sqrt(square(avg_avg_customer - avg_personal)),2)               # how different from other people
        rating = round(avg_movies,3)
        diff = (avg_personal - avg_avg_customer)
        movies_diff = (avg_movies - avg_avg_movies)

        if(round(movies_diff,3) < 0):
            movies_quality = "bad"
            rating -= diff/10 + movies_diff/10
        elif(round(movies_diff,3) == 0):
            movies_quality = "average"
        else:
            movies_quality = "good"
            rating += diff/10 + movies_diff/10
        if(rating > 5):
            rating = 5.0

    
        #print(i,"\t",movies_quality,"\t\t   ", avg_personal,"\t", movies_diff, "  \t\t",diff, "   \t\t",round(rating,1), "\t\t",expected_rate)
        #print("------------------------------------------------------------------------------------------------------------")
    


    return round(rating, 1)


# ------------
# netflix_rmse
# ------------

def netflix_rmse (i, j, v):
    """
    i movies_id
    j customer_id
    return rating
    """
    global total_viewer
    square_error = 0
    if(j!=0):
        total_viewer+=1
        expected_rate = expected[str(i)][str(j)]
        square_error = square(expected_rate - v)
        #print(v, expected_rate, square_error)

    #return sqrt(mean(square(subtract(i, j))))
    return square_error

# -------------
# netflix_print
# -------------

def netflix_print (w, i, j, v) :
    """
    print three ints
    w a writer
    i movies_id
    j customer_id
    v rating
    """

    if (j == 0) :
        w.write(str(i) + ":\n")
    else :
        w.write(str(v) + "\n")

# -------------
# netflix_solve
# -------------

def netflix_solve (r, w) :
    """
    r a reader
    w a writer
    """
    global avg_movies_rate
    global avg_customer_rate
    global expected
    avg_customer_rate = json_cache('http://www.cs.utexas.edu/users/ebanner/netflix-tests/ezo55-Average_Viewer_Rating_Cache.json')
    avg_movies_rate = json_cache('http://www.cs.utexas.edu/users/ebanner/netflix-tests/BRG564-Average_Movie_Rating_Cache.json')
    expected = json_cache('http://www.cs.utexas.edu/users/ebanner/netflix-tests/pam2599-probe_solutions.json')

    #a = [0,3.4,1.3,4.3,0,3.2,4.4,4.8]
    sq_error = 0
    #print("m_id\tmovies_qual\tc_id\t\tviewer_qual\t\tdiff\t\trating\t\texpected_rate")
    #counter = 0
    for s in r :
        i, j = netflix_read(s)
        v = netflix_eval(i, j)
        #v = a[counter]
        sq_error += netflix_rmse(i,j,v)
        
        #counter+=1
        #netflix_print (w, i, j, v)
    rmse = sqrt(sq_error/total_viewer)
    print("RMSE:", rmse)
